name: Sync and Convert Gemini Rules

permissions:
  contents: write   # 授予写权限

on:
  schedule:
    - cron: '0 0 * * *'   # 每天 UTC 0:00 执行（北京时间 8:00）
  workflow_dispatch:      # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Download original Clash rules
        run: |
          curl -L -o original.yaml https://raw.githubusercontent.com/Accademia/Additional_Rule_For_Clash/refs/heads/main/Gemini/Gemini_Domain.yaml

      - name: Convert to Shadowrocket format
        run: |
          mkdir -p Ruleset  # 创建文件夹（如果已存在无影响）
          cat > convert.py << 'EOF'
          import yaml
          import datetime
          import re

          # 读取原文件
          with open('original.yaml', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)

          rules = set()  # 用 set 去重

          for item in data.get('payload', []):
              if not isinstance(item, str):
                  continue
              item = item.strip()
              if item.startswith('+.'):
                  domain = item[2:]  # 去掉 +.
                  if '*' in domain:
                      base = re.split(r'\*', domain)[0].rstrip('.')
                      if base:
                          rules.add(f'DOMAIN-KEYWORD,{base}')
                  else:
                      rules.add(f'DOMAIN-SUFFIX,{domain}')
              else:
                  domain = item
                  if '*' in domain:
                      base = re.split(r'\*', domain)[0].rstrip('.')
                      if base:
                          rules.add(f'DOMAIN-KEYWORD,{base}')
                  else:
                      rules.add(f'DOMAIN,{domain}')

          # 排序并写入文件
          sorted_rules = sorted(rules)

          with open('Ruleset/Gemini.list', 'w', encoding='utf-8') as f:
              f.write('# Gemini Domain Rules for Shadowrocket\n')
              f.write('# 原作者仓库：https://github.com/Accademia/Additional_Rule_For_Clash\n')
              f.write(f'# 最后更新时间：{datetime.datetime.utcnow().isoformat()} UTC\n')
              f.write('# 使用方式：在Shadowrocket配置中添加 RULE-SET,https://raw.githubusercontent.com/Asanagi8/Rules/main/Ruleset/Gemini.list,你的策略组名\n\n')
              f.write('\n'.join(sorted_rules))
              f.write('\n')
          EOF
          python3 convert.py

      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions@github.com'
          git add Ruleset/Gemini.list
          if git diff --staged --quiet; then
            echo "无变化，无需提交"
          else
            git commit -m "Auto update Gemini rules $(date -u)"
            git push
          fi
